import requests
import telebot
from telebot import types
import re # Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·

# **1. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª (Configuration)**
BOT_TOKEN = "Ø¶Ø¹_Ø§Ù„ØªÙˆÙƒÙ†_Ø§Ù„Ø®Ø§Øµ_Ø¨Ùƒ_Ù‡Ù†Ø§" # ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª
DEVELOPER_USER_ID = "1315011160" # Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø·ÙˆØ±
CHANNEL_USERNAME = "@SuPeRx1" # Ø§Ø³Ù… Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª Ø£Ùˆ Ø§Ù„Ù…Ø·ÙˆØ±
TIKTOK_API = 'https://dev-broksuper.pantheonsite.io/api/e/mp3.php?url='
INSTAGRAM_API = 'https://dev-broksuper.pantheonsite.io/api/ink.php?url='

bot = telebot.TeleBot(BOT_TOKEN)

# **2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Start Command)**
@bot.message_handler(commands=["start"])
def send_welcome(message):
    markup = types.InlineKeyboardMarkup(row_width=2)
    tt_btn = types.InlineKeyboardButton("ØªØ­Ù…ÙŠÙ„ ØªÙŠÙƒ ØªÙˆÙƒ ğŸ¶", callback_data="download_tiktok")
    ig_btn = types.InlineKeyboardButton("ØªØ­Ù…ÙŠÙ„ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… ğŸ“¸", callback_data="download_instagram")
    dev_btn = types.InlineKeyboardButton("Ø§Ù„Ù…Ø·ÙˆØ± ğŸ‘¨â€ğŸ’»", url=f"tg://user?id={DEVELOPER_USER_ID}")
    
    markup.add(tt_btn, ig_btn, dev_btn)
    
    bot.send_message(
        message.chat.id,
        f"""
        **Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ {message.from_user.first_name}!** ğŸ‘‹
        
        Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„. Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ù‡Ø§:
        * Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙˆØ±Ø§Ù‹.
        """,
        parse_mode='markdown',
        reply_markup=markup
    )

# **3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù€ Callback (Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)**
@bot.callback_query_handler(func=lambda call: call.data in ['download_tiktok', 'download_instagram'])
def handle_download_choice(call):
    # Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ù„ØªØ¬Ù†Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text="""
        **ğŸš€ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¢Ù†!** Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚.
        """,
        parse_mode='markdown'
    )
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (Next Step) Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if call.data == 'download_tiktok':
        bot.register_next_step_handler(call.message, process_tiktok_link)
    elif call.data == 'download_instagram':
        bot.register_next_step_handler(call.message, process_instagram_link)
        
# **4. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙˆØ§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ**
def process_tiktok_link(message):
    user_url = message.text
    
    if not re.match(r'https?://(?:www\.)?tiktok\.com/', user_url):
        bot.send_message(message.chat.id, "**âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­!** ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ ØµØ­ÙŠØ­.", parse_mode='markdown')
        return
        
    bot.send_message(message.chat.id, "<strong>â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ØªÙŠÙƒ ØªÙˆÙƒ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.</strong>", parse_mode="html")
    
    try:
        response = requests.get(f'{TIKTOK_API}{user_url}').json()
        video_url = response.get("video", {}).get("videoURL")
        audio_url = response.get("audioURL")
        
        if video_url:
            bot.send_video(message.chat.id, video_url, caption=f'**âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ÙˆØ§Ø³Ø·Ø©: {CHANNEL_USERNAME}**', parse_mode='markdown')
        
        if audio_url:
            bot.send_voice(message.chat.id, audio_url, caption=f'**ğŸ§ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø©: {CHANNEL_USERNAME}**', parse_mode='markdown')
            
        if not video_url and not audio_url:
             bot.send_message(message.chat.id, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø§Ù….", parse_mode='markdown')
    
    except Exception as e:
        print(f"Error in TikTok: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.")

# **5. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙˆØ§Ø¨Ø· Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…**
def process_instagram_link(message):
    user_url = message.text
    
    if not re.match(r'https?://(?:www\.)?instagram\.com/', user_url):
        bot.send_message(message.chat.id, "**âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­!** ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù… ØµØ­ÙŠØ­.", parse_mode='markdown')
        return

    bot.send_message(message.chat.id, f"""<strong>â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.</strong>""", parse_mode="html")
    
    try:
        response = requests.get(f"{INSTAGRAM_API}{user_url}").json()
        media_url = response.get('media')
        
        if media_url:
            # ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙŠØ¯ÙŠØ§ ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙŠ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù€ API
            # ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©.
            bot.send_video(message.chat.id, media_url, caption=f"**âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø©: {CHANNEL_USERNAME}**", parse_mode='markdown')
        else:
            bot.send_message(message.chat.id, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ø· ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø§ØµØ§Ù‹ Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­.")

    except Exception as e:
        print(f"Error in Instagram: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.")

# **6. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¦Ù… (Polling)**
print('Bot is running...')
bot.infinity_polling()

